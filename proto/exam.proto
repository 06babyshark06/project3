syntax = "proto3";

package exam;

option go_package = "shared/proto/exam;exam";

service ExamService {
  rpc CreateTopic(CreateTopicRequest) returns (CreateTopicResponse);
  rpc GetTopics(GetTopicsRequest) returns (GetTopicsResponse);
  rpc CreateSection(CreateSectionRequest) returns (CreateSectionResponse);
  rpc GetSections(GetSectionsRequest) returns (GetSectionsResponse);
  rpc UpdateTopic(UpdateTopicRequest) returns (UpdateTopicResponse);
  rpc DeleteTopic(DeleteTopicRequest) returns (DeleteTopicResponse);
  rpc UpdateSection(UpdateSectionRequest) returns (UpdateSectionResponse);
  rpc DeleteSection(DeleteSectionRequest) returns (DeleteSectionResponse);

  rpc GetQuestions(GetQuestionsRequest) returns (GetQuestionsResponse);
  rpc CreateQuestion(CreateQuestionRequest) returns (CreateQuestionResponse);
  rpc GetQuestion(GetQuestionRequest) returns (GetQuestionResponse);
  rpc ImportQuestions(ImportQuestionsRequest) returns (ImportQuestionsResponse);
  rpc UpdateQuestion(UpdateQuestionRequest) returns (UpdateQuestionResponse);
  rpc DeleteQuestion(DeleteQuestionRequest) returns (DeleteQuestionResponse);

  rpc GetUploadURL(GetUploadURLRequest) returns (GetUploadURLResponse);

  rpc CreateExam(CreateExamRequest) returns (CreateExamResponse);
  rpc GenerateExam(GenerateExamRequest) returns (CreateExamResponse);
  rpc GetExamDetails(GetExamDetailsRequest) returns (GetExamDetailsResponse);
  rpc GetExams(GetExamsRequest) returns (GetExamsResponse);
  rpc UpdateExam(UpdateExamRequest) returns (UpdateExamResponse);
  rpc DeleteExam(DeleteExamRequest) returns (DeleteExamResponse);
  rpc PublishExam(PublishExamRequest) returns (PublishExamResponse);

  rpc RequestExamAccess(RequestExamAccessRequest) returns (RequestExamAccessResponse);
  rpc ApproveExamAccess(ApproveExamAccessRequest) returns (ApproveExamAccessResponse);
  rpc CheckExamAccess(CheckExamAccessRequest) returns (CheckExamAccessResponse);
  rpc GetAccessRequests(GetAccessRequestsRequest) returns (GetAccessRequestsResponse);

  rpc SubmitExam(SubmitExamRequest) returns (SubmitExamResponse);
  rpc GetSubmission(GetSubmissionRequest) returns (GetSubmissionResponse);
  rpc GetUserExamStats(GetUserExamStatsRequest) returns (GetUserExamStatsResponse);
  rpc GetExamCount(GetExamCountRequest) returns (GetExamCountResponse);

  rpc SaveAnswer(SaveAnswerRequest) returns (SaveAnswerResponse);
  rpc LogViolation(LogViolationRequest) returns (LogViolationResponse);
  rpc GetExamStatsDetailed(GetExamStatsDetailedRequest) returns (GetExamStatsDetailedResponse);
  rpc ExportExamResults(ExportExamResultsRequest) returns (ExportExamResultsResponse);
  rpc GetExamViolations(GetExamViolationsRequest) returns (GetExamViolationsResponse);
  rpc ExportQuestions(ExportQuestionsRequest) returns (ExportQuestionsResponse);
  rpc StartExam(StartExamRequest) returns (StartExamResponse);

  rpc GetExamsByClass(GetExamsByClassRequest) returns (GetExamsByClassResponse);
  rpc AssignExamToClass(AssignExamToClassRequest) returns (AssignExamToClassResponse);
  rpc UnassignExamFromClass(AssignExamToClassRequest) returns (AssignExamToClassResponse);
  rpc GetInstructorExams(GetInstructorExamsRequest) returns (GetInstructorExamsResponse);
}

message Topic {
  int64 id = 1;
  string name = 2;
  string description = 3;
}

message Section {
  int64 id = 1;
  string name = 2;
  string description = 3;
  int64 topic_id = 4;
}
message CreateTopicRequest { string name = 1; string description = 2; }
message CreateTopicResponse { Topic topic = 1; }
message GetTopicsRequest {}
message GetTopicsResponse { repeated Topic topics = 1; }

message CreateSectionRequest { string name = 1; string description = 2; int64 topic_id = 3; }
message CreateSectionResponse { Section section = 1; }
message GetSectionsRequest { int64 topic_id = 1; }
message GetSectionsResponse { repeated Section sections = 1; }

message ChoiceInput { string content = 1; bool is_correct = 2; string attachment_url = 3; }
message CreateQuestionRequest {
  int64 section_id = 1;
  string content = 2;
  string question_type = 3;
  string difficulty = 4;
  string explanation = 5;
  repeated ChoiceInput choices = 6;
  int64 creator_id = 7;
  string attachment_url = 8;
}
message CreateQuestionResponse { int64 id = 1; string content = 2; }

message GetUploadURLRequest {
  string file_name = 1;
  string content_type = 2;
  string folder = 3;
}
message GetUploadURLResponse {
  string upload_url = 1;
  string final_url = 2;
}

message ImportQuestionsRequest {
  int64 creator_id = 2;
  bytes file_content = 3;
}
message ImportQuestionsResponse { int32 success_count = 1; int32 error_count = 2; }

message ExamSettings {
  int32 duration_minutes = 1;
  int32 max_attempts = 2;
  string password = 3;
  string start_time = 4;
  string end_time = 5;
  bool shuffle_questions = 6;
  bool show_result_immediately = 7;
  bool requires_approval = 8;
}

message CreateExamRequest {
  string title = 1;
  string description = 2;
  int64 topic_id = 3;
  repeated int64 question_ids = 4;
  ExamSettings settings = 5;
  int64 creator_id = 6;
  string status = 7;
}

message SectionConfig {
  int64 section_id = 1;
  int32 count = 2;
  string difficulty = 3;
}

message GenerateExamRequest {
  string title = 1;
  string description = 2;
  int64 topic_id = 3;
  ExamSettings settings = 4;
  int64 creator_id = 5;
  repeated SectionConfig section_configs = 6;
}

message CreateExamResponse { int64 id = 1; string title = 2; }

message ChoiceDetails { int64 id = 1; string content = 2; bool is_correct = 3; string attachment_url = 4; }
message QuestionDetails {
  int64 id = 1;
  string content = 2;
  repeated ChoiceDetails choices = 3;
  string question_type = 4;
  string attachment_url = 5;
  string difficulty = 6;
  string explanation = 7;
  string section_name = 8;
  string topic_name = 9;
  int64 section_id = 10;
  int64 topic_id = 11;
}

message GetExamDetailsRequest { int64 exam_id = 1; }
message GetExamDetailsResponse {
  int64 id = 1;
  string title = 2;
  string description = 3;
  ExamSettings settings = 4;
  repeated QuestionDetails questions = 5;
  int64 topic_id = 6;
  string status = 7;
}

message RequestExamAccessRequest { int64 exam_id = 1; int64 user_id = 2; string student_name = 3; }
message RequestExamAccessResponse { bool success = 1; string status = 2; }

message ApproveExamAccessRequest { int64 exam_id = 1; int64 student_id = 2; bool is_approved = 3; }
message ApproveExamAccessResponse { bool success = 1; }

message CheckExamAccessRequest { int64 exam_id = 1; int64 user_id = 2; }
message CheckExamAccessResponse { bool can_access = 1; string message = 2; }

message GetQuestionRequest { int64 question_id = 1; }
message GetQuestionResponse { QuestionDetails question = 1; }
message UpdateQuestionRequest { int64 question_id = 1; string content = 2; string question_type = 3; string difficulty = 4; string explanation = 5; repeated ChoiceInput choices = 6; string attachment_url = 7; }
message UpdateQuestionResponse { bool success = 1; }
message DeleteQuestionRequest { int64 question_id = 1; }
message DeleteQuestionResponse { bool success = 1; }

message ExamListItem { int64 id = 1; string title = 2; int32 duration_minutes = 3; int64 topic_id = 4; int64 creator_id = 5; string status = 6; }
message GetExamsRequest { int32 page = 1; int32 limit = 2; int64 creator_id = 3; string status = 4; }
message GetExamsResponse { repeated ExamListItem exams = 1; int64 total = 2; int32 page = 3; int32 total_pages = 4; }

message UpdateExamRequest { int64 exam_id = 1; string title = 2; string description = 3; ExamSettings settings = 4; int64 topic_id = 5; repeated int64 question_ids = 6; string status = 7;}
message UpdateExamResponse { bool success = 1; }
message DeleteExamRequest { int64 exam_id = 1; }
message DeleteExamResponse { bool success = 1; }
message PublishExamRequest { int64 exam_id = 1; string status = 2; }
message PublishExamResponse { bool success = 1; }

message UserAnswer { int64 question_id = 1; int64 chosen_choice_id = 2; }
message SubmitExamRequest { int64 exam_id = 1; int64 user_id = 2; repeated UserAnswer answers = 3; }
message SubmitExamResponse { int64 submission_id = 1; float score = 2; int32 correct_count = 3; int32 total_questions = 4; }

message GetSubmissionRequest { int64 submission_id = 1; int64 user_id = 2; }
message SubmissionDetail { int64 question_id = 1; string question_content = 2; string explanation = 3; string question_type = 4; bool is_correct = 5; repeated ChoiceReview choices = 6; string attachment_url = 7; }
message ChoiceReview { int64 id = 1; string content = 2; bool is_correct = 3; bool user_selected = 4; string attachment_url = 5; }
message GetSubmissionResponse { int64 id = 1; string exam_title = 2; float score = 3; int32 correct_count = 4; int32 total_questions = 5; string status = 6; string submitted_at = 7; repeated SubmissionDetail details = 8; }

message GetUserExamStatsRequest { int64 user_id = 1; }
message GetUserExamStatsResponse { int64 total_exams_taken = 1; }
message GetExamCountRequest {}
message GetExamCountResponse { int64 count = 1; }

message SaveAnswerRequest {
  int64 user_id = 1;
  int64 exam_id = 2;
  int64 question_id = 3;
  int64 chosen_choice_id = 4;
}
message SaveAnswerResponse { bool success = 1; }

message LogViolationRequest {
  int64 user_id = 1;
  int64 exam_id = 2;
  string violation_type = 3;
  string violation_time = 4;
}
message LogViolationResponse { bool success = 1; }

message GetExamStatsDetailedRequest { int64 exam_id = 1; }
message GetExamStatsDetailedResponse {
  int64 total_students = 1;
  int64 submitted_count = 2;
  double average_score = 3;
  double highest_score = 4;
  double lowest_score = 5;
  map<string, int32> score_distribution = 6;
}

message ExportExamResultsRequest { int64 exam_id = 1; int64 requester_id = 2; }
message ExportExamResultsResponse { string file_url = 1; }

message GetQuestionsRequest {
  int32 page = 1;
  int32 limit = 2;
  int64 section_id = 3;
  string difficulty = 4;
  string search = 5;
  int64 topic_id = 6;
}

message QuestionListItem {
  int64 id = 1;
  string content = 2;
  string question_type = 3;
  string difficulty = 4;
  int64 section_id = 5;
  string section_name = 6;
  int64 topic_id = 7;
  string topic_name = 8;
  string attachment_url = 9;
  int32 choice_count = 10;
}

message GetQuestionsResponse {
  repeated QuestionListItem questions = 1;
  int64 total = 2;
  int32 page = 3;
  int32 total_pages = 4;
}

message ExamViolation {
  int64 id = 1;
  int64 user_id = 2;
  string violation_type = 3;
  string violation_time = 4;
}

message GetExamViolationsRequest {
  int64 exam_id = 1;
}

message GetExamViolationsResponse {
  repeated ExamViolation violations = 1;
}

message ExportQuestionsRequest {
  int64 section_id = 1;
  int64 topic_id = 2;
  string difficulty = 3;
  string search = 4;
  int64 creator_id = 5;
}

message ExportQuestionsResponse {
  string file_url = 1;
}

message StartExamRequest {
  int64 exam_id = 1;
  int64 user_id = 2;
}

message StartExamResponse {
  int64 submission_id = 1;
  int32 remaining_seconds = 2;
  map<int64, Int64List> current_answers = 3;
}

message Int64List {
  repeated int64 values = 1;
}

message GetAccessRequestsRequest {
  int64 exam_id = 1;
  int64 creator_id = 2;
}

message AccessRequestItem {
  int64 id = 1;
  int64 user_id = 2;
  string status = 3;
  string created_at = 4;
  string full_name = 5;
}

message GetAccessRequestsResponse {
  repeated AccessRequestItem requests = 1;
}

message UpdateTopicRequest { int64 id = 1; string name = 2; string description = 3; }
message UpdateTopicResponse { bool success = 1; }

message DeleteTopicRequest { int64 id = 1; }
message DeleteTopicResponse { bool success = 1; }

message UpdateSectionRequest { int64 id = 1; string name = 2; string description = 3; }
message UpdateSectionResponse { bool success = 1; }

message DeleteSectionRequest { int64 id = 1; }
message DeleteSectionResponse { bool success = 1; }

message GetExamsByClassRequest {
  int64 class_id = 1;
  string status = 2;
}

message GetExamsByClassResponse {
  repeated Exam exams = 1;
}

message AssignExamToClassRequest {
  int64 exam_id = 1;
  int64 class_id = 2;
}

message AssignExamToClassResponse {
  bool success = 1;
}

message GetInstructorExamsRequest {
  int64 teacher_id = 1;
}

message GetInstructorExamsResponse {
  repeated Exam exams = 1;
}

message Exam {
  int64 id = 1;
  string title = 2;
  string description = 3;
  int32 duration_minutes = 4;
  int64 topic_id = 5;
  int64 creator_id = 6;
  string created_at = 7;
  int32 question_count = 8;
  string status = 9;
}